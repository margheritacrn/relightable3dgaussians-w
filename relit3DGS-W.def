Bootstrap: docker
# From: nvidia/cuda:11.7.1-cudnn8-devel-ubuntu22.04

From: nvidia/cuda:12.1.0-cudnn8-devel-ubuntu22.04
%files
  # Copies over the source code for the relightable3dgaussians-w training script
  . /opt/relightable3dgaussians-w

%environment
  # The Anaconda environment needs to be available during execution
  export "PATH=/opt/conda/bin:$PATH"

%post
  # Installs some general dependencies
  apt-get -y update
  apt-get -y install curl
  apt-get install openssl
  apt-get install ca-certificates
  export SSL_CERT_DIR=/etc/ssl/certs
  apt-get install gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget -y

  # Downloads and installs Miniconda3 
  curl -o ~/miniconda.sh -O https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh
  # curl -o ~/miniconda.sh -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  
  chmod +x ~/miniconda.sh
  ~/miniconda.sh -b -p /opt/conda
  rm ~/miniconda.sh
  ln -sf /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /opt/conda/lib/libstdc++.so.6
  export "PATH=/opt/conda/bin:$PATH"

  # Installs PyTorch according to https://pytorch.org/get-started/locally/
  conda env update -n base -f /opt/relightable3dgaussians-w/environment.yml
  pip install /opt/relightable3dgaussians-w/nvdiffrast


%runscript
  # Starts the training relightable3dgaussians-w on NeRF-OSR dataset
  cd /opt/relightable3dgaussians-w
  python full_eval.py "$@"